<script type="text/javascript">
    RED.nodes.registerType('omron-fins', {
        category: 'MACHHUB Comms',
        color: '#3FADB5',
        defaults: {
            name: {value: ""},
            connection: {value: "", type: "omron-fins-config", required: true},
            inputMode: {value: "node"},
            operation: {value: "read"},
            address: {value: ""},
            dataType: {value: "DM"},
            mode: {value: "RUN"},
            addressMode: {value: "single"},
            addressList: {value: []},
            dataFormat: {value: "array"}
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.svg",
        label: function() {
            if (this.name) return this.name;
            if (this.addressMode === 'multiple' && this.addressList && this.addressList.length > 0) {
                return "omron-fins (" + this.addressList.length + " addresses)";
            }
            return "omron-fins";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var node = this;
            
            var updateFields = function() {
                var operation = $('#node-input-operation').val();
                var addressMode = $('#node-input-addressMode').val();
                var inputMode = $('#node-input-inputMode').val();
                
                // If input mode is 'msg', hide config fields
                if (inputMode === 'msg') {
                    $('.form-row-operation').hide();
                    $('.form-row-datatype').hide();
                    $('.form-row-address').hide();
                    $('.form-row-addressMode').hide();
                    $('.form-row-dataFormat').hide();
                    $('.form-row-mode').hide();
                    $('.form-row-addressList').hide();
                    return;
                }
                
                // Show all fields for 'node' mode
                $('.form-row-operation').show();
                $('.form-row-datatype').show();
                $('.form-row-addressMode').show();
                
                if (operation === 'mode') {
                    $('.form-row-address').hide();
                    $('.form-row-addressMode').hide();
                    $('.form-row-addressList').hide();
                    $('.form-row-datatype').hide();
                    $('.form-row-dataFormat').hide();
                    $('.form-row-mode').show();
                } else {
                    $('.form-row-mode').hide();
                    $('.form-row-datatype').show();
                    $('.form-row-addressMode').show();
                    
                    if (addressMode === 'single') {
                        $('.form-row-address').show();
                        $('.form-row-addressList').hide();
                        $('.form-row-dataFormat').show();
                    } else {
                        $('.form-row-address').hide();
                        $('.form-row-addressList').show();
                        $('.form-row-dataFormat').hide();
                    }
                }
            };
            
            // Generate address list UI
            var generateAddressList = function() {
                var container = $('#node-input-addressList-container');
                container.empty();
                
                node.addressList.forEach(function(item, index) {
                    var row = $('<div/>',{class:'address-list-row'}).css({
                        marginBottom: '10px',
                        padding: '8px',
                        border: '1px solid #ccc',
                        borderRadius: '3px'
                    }).appendTo(container);
                    
                    $('<input/>',{type:'text', placeholder:'Address (e.g., 100 or 100.05)', value: item.address || ''})
                        .css({width: '80px', marginRight: '5px'})
                        .on('change', function() { 
                            node.addressList[index].address = $(this).val();
                            RED.nodes.dirty(true);
                        })
                        .appendTo(row);
                    
                    $('<select/>').css({width: '70px', marginRight: '5px'})
                        .append($('<option/>',{value:'CIO',text:'CIO'}))
                        .append($('<option/>',{value:'WR',text:'WR'}))
                        .append($('<option/>',{value:'HR',text:'HR'}))
                        .append($('<option/>',{value:'AR',text:'AR'}))
                        .append($('<option/>',{value:'DM',text:'DM'}))
                        .append($('<option/>',{value:'EM',text:'EM'}))
                        .val(item.dataType || 'DM')
                        .on('change', function() { 
                            node.addressList[index].dataType = $(this).val();
                            RED.nodes.dirty(true);
                        })
                        .appendTo(row);
                    
                    $('<input/>',{type:'number', placeholder:'Count', value: item.count || 1, min:1})
                        .css({width: '60px', marginRight: '5px'})
                        .on('change', function() { 
                            node.addressList[index].count = parseInt($(this).val()) || 1;
                            RED.nodes.dirty(true);
                        })
                        .appendTo(row);
                    
                    $('<select/>').css({width: '100px', marginRight: '5px'})
                        .append($('<option/>',{value:'array',text:'Number'}))
                        .append($('<option/>',{value:'unsigned',text:'Unsigned'}))
                        .append($('<option/>',{value:'int32',text:'Int32'}))
                        .append($('<option/>',{value:'float32',text:'Float32'}))
                        .append($('<option/>',{value:'binary',text:'Binary'}))
                        .append($('<option/>',{value:'hex',text:'Hex'}))
                        .append($('<option/>',{value:'ascii',text:'ASCII'}))
                        .append($('<option/>',{value:'buffer',text:'Buffer'}))
                        .append($('<option/>',{value:'bits',text:'Bits'}))
                        .val(item.dataFormat || 'array')
                        .on('change', function() { 
                            node.addressList[index].dataFormat = $(this).val();
                            RED.nodes.dirty(true);
                        })
                        .appendTo(row);
                    
                    $('<button/>',{type:'button',class:'red-ui-button'}).text('Remove')
                        .css({marginLeft: '5px'})
                        .on('click', function() {
                            node.addressList.splice(index, 1);
                            RED.nodes.dirty(true);
                            generateAddressList();
                        })
                        .appendTo(row);
                });
                
                var addBtn = $('<button/>',{type:'button',class:'red-ui-button'}).text('+ Add Address')
                    .css({marginTop: '5px'})
                    .on('click', function() {
                        node.addressList.push({address: '', dataType: 'DM', count: 1, dataFormat: 'array'});
                        RED.nodes.dirty(true);
                        generateAddressList();
                    });
                container.append(addBtn);
            };
            
            // Initialize address list
            if (!node.addressList || node.addressList.length === 0) {
                node.addressList = [];
            }
            generateAddressList();
            
            $('#node-input-operation').on('change', updateFields);
            $('#node-input-addressMode').on('change', updateFields);
            $('#node-input-inputMode').on('change', updateFields);
            updateFields();
        }
    });
</script>

<script type="text/html" data-template-name="omron-fins">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-globe"></i> Connection</label>
        <input type="text" id="node-input-connection">
    </div>
    <div class="form-row">
        <label for="node-input-inputMode"><i class="fa fa-cog"></i> Input Mode</label>
        <select id="node-input-inputMode" style="width:70%">
            <option value="node">Use Node Settings</option>
            <option value="msg">Use Input Message</option>
        </select>
    </div>
    <div class="form-row form-row-operation">
        <label for="node-input-operation"><i class="fa fa-tasks"></i> Operation</label>
        <select id="node-input-operation">
            <option value="read">Read</option>
            <option value="write">Write</option>
            <option value="mode">Change Mode</option>
        </select>
    </div>
    <div class="form-row form-row-datatype">
        <label for="node-input-dataType"><i class="fa fa-database"></i> Data Type</label>
        <select id="node-input-dataType">
            <option value="CIO">CIO</option>
            <option value="WR">WR</option>
            <option value="HR">HR</option>
            <option value="AR">AR</option>
            <option value="DM">DM</option>
            <option value="EM">EM</option>
        </select>
    </div>
    <div class="form-row form-row-addressMode">
        <label for="node-input-addressMode"><i class="fa fa-list"></i> Address Mode</label>
        <select id="node-input-addressMode">
            <option value="single">Single Address</option>
            <option value="multiple">Multiple Addresses</option>
        </select>
    </div>
    <div class="form-row form-row-dataFormat">
        <label for="node-input-dataFormat"><i class="fa fa-cog"></i> Data Format</label>
        <select id="node-input-dataFormat">
            <option value="array">Number Array (signed)</option>
            <option value="unsigned">Unsigned Number Array</option>
            <option value="int32">32-bit Integer Array</option>
            <option value="float32">32-bit Float Array</option>
            <option value="binary">Binary String Array</option>
            <option value="hex">Hex String Array</option>
            <option value="ascii">ASCII String</option>
            <option value="buffer">Buffer</option>
            <option value="bits">Bit Array</option>
        </select>
    </div>
    <div class="form-row form-row-address">
        <label for="node-input-address"><i class="fa fa-map-marker"></i> Address</label>
        <input type="text" id="node-input-address" placeholder="e.g., 100 or 100.05 (bit 5)">
    </div>
    <div class="form-row form-row-addressList" style="display: none;">
        <label><i class="fa fa-list"></i> Addresses</label>
        <div id="node-input-addressList-container" style="min-height: 100px;"></div>
    </div>
    <div class="form-row form-row-mode" style="display: none;">
        <label for="node-input-mode"><i class="fa fa-play-circle"></i> Mode</label>
        <select id="node-input-mode">
            <option value="RUN">RUN</option>
            <option value="MONITOR">MONITOR</option>
            <option value="STOP">STOP</option>
        </select>
    </div>
</script>

<script type="text/html" data-help-name="omron-fins">
    <p>Communicate with Omron PLCs using the FINS protocol.</p>
    
    <h3>Configuration</h3>
    <p><b>Input Mode:</b> Controls whether the node uses its configured settings or reads parameters from the input message.</p>
    <ul>
        <li><b>Use Node Settings:</b> Uses the operation, data type, and address configured in this node. Input message properties are ignored.</li>
        <li><b>Use Input Message:</b> Reads all parameters from the input message (<code>msg.operation</code>, <code>msg.dataType</code>, <code>msg.address</code>, etc.). Node configuration fields are disabled and ignored.</li>
    </ul>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">operation <span class="property-type">string</span></dt>
        <dd>The operation to perform: "read", "write", or "mode". <b>Required when Input Mode is "Use Input Message".</b></dd>
        
        <dt class="optional">address <span class="property-type">string | array</span></dt>
        <dd>Memory address to read/write. Not required for mode operation.<br>
        <b>Format:</b> Word address (e.g., "100") or bit address (e.g., "100.05" for bit 5 of word 100).<br>
        <b>Bit Addressing:</b> Use format "word.bit" where bit is 0-15 (bit 0 is LSB, bit 15 is MSB).<br>
        For multi-address read, provide an array of addresses (strings) or objects with {address, count, dataType}.</dd>
        
        <dt class="optional">dataType <span class="property-type">string</span></dt>
        <dd>Memory area type (CIO, WR, HR, AR, DM, EM). <b>Required when Input Mode is "Use Input Message".</b></dd>
        
        <dt class="optional">mode <span class="property-type">string</span></dt>
        <dd>PLC operating mode: "RUN", "MONITOR", or "STOP". Required for mode operation.</dd>
        
        <dt class="optional">count <span class="property-type">number</span></dt>
        <dd>Number of items to read (for read operations only). Default: 1<br>
        <b>Word Addressing:</b> Count represents number of words (16-bit values).<br>
        <b>Bit Addressing:</b> Count represents number of bits. Bits can span multiple words.</dd>
        
        <dt class="optional">dataFormat <span class="property-type">string</span></dt>
        <dd>Output format for read data. Options: "array" (signed 16-bit), "unsigned", "int32", "float32", "binary", "hex", "ascii", "buffer", "bits". Overrides node configuration.</dd>
        
        <dt class="optional">payload <span class="property-type">number | array | boolean</span></dt>
        <dd>Data to write (for write operations).<br>
        <b>Word Write:</b> Can be a single value or array of values (16-bit integers).<br>
        <b>Bit Write:</b> Can be a single boolean/bit value or array of boolean/bit values (true/false, 1/0).</dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">varies</span></dt>
        <dd>The data read from the PLC formatted according to the Data Format setting:
            <ul>
                <li><b>Number Array</b>: Array of signed 16-bit integers (default)</li>
                <li><b>Unsigned Number Array</b>: Array of unsigned 16-bit integers (0-65535)</li>
                <li><b>32-bit Integer Array</b>: Array of 32-bit signed integers (pairs of words)</li>
                <li><b>32-bit Float Array</b>: Array of IEEE 754 floats (pairs of words)</li>
                <li><b>Binary String Array</b>: Array of 16-bit binary strings</li>
                <li><b>Hex String Array</b>: Array of hexadecimal strings</li>
                <li><b>ASCII String</b>: ASCII text string</li>
                <li><b>Buffer</b>: Raw Node.js Buffer object</li>
                <li><b>Bit Array</b>: Array of arrays, each containing 16 booleans</li>
            </ul>
        </dd>
    </dl>

    <h3>Details</h3>
    <p>This node communicates with Omron PLCs using the FINS (Factory Interface Network Service) protocol over TCP/IP.</p>
    
    <h4>Operations</h4>
    <ul>
        <li><b>Read</b>: Read data from PLC memory</li>
        <li><b>Write</b>: Write data to PLC memory</li>
        <li><b>Change Mode</b>: Change PLC operating mode (RUN/MONITOR/STOP)</li>
    </ul>
    
    <h4>PLC Modes</h4>
    <ul>
        <li><b>RUN</b>: Normal operating mode - program executes and I/O is active</li>
        <li><b>MONITOR</b>: Program executes but outputs are disabled</li>
        <li><b>STOP</b>: Program does not execute</li>
    </ul>
    
    <h4>Memory Areas</h4>
    <ul>
        <li><b>CIO</b>: Core I/O area</li>
        <li><b>WR</b>: Work area</li>
        <li><b>HR</b>: Holding area</li>
        <li><b>AR</b>: Auxiliary area</li>
        <li><b>DM</b>: Data memory area</li>
        <li><b>EM</b>: Extended memory area</li>
    </ul>
    
    <h4>Bit Addressing</h4>
    <p>You can specify individual bits within a word using the format <code>word.bit</code> where bit is 0-15.</p>
    <ul>
        <li><b>Bit 0</b>: Least Significant Bit (LSB)</li>
        <li><b>Bit 15</b>: Most Significant Bit (MSB)</li>
    </ul>
    <p><b>Examples:</b></p>
    <ul>
        <li><code>"100.00"</code>: Bit 0 (LSB) of DM100</li>
        <li><code>"100.05"</code>: Bit 5 of DM100</li>
        <li><code>"100.15"</code>: Bit 15 (MSB) of DM100</li>
    </ul>
    <p><b>Bit Counting:</b> When using bit addressing, the <code>count</code> parameter represents the number of bits to read/write. Bits can span multiple words (e.g., reading 5 bits starting from bit 14 will read bits 14-15 from one word and bits 0-2 from the next word).</p>
    <p><b>Bit Write:</b> Bit writes use read-modify-write to preserve other bits in the word. Only the specified bits are modified.</p>

    <h4>Configuration</h4>
    <p>You can configure the operation, data type, and address in the node properties, or override them dynamically by setting <code>msg.operation</code>, <code>msg.dataType</code>, and <code>msg.address</code>.</p>

    <h4>Examples</h4>
    <p><b>Read Example:</b></p>
    <pre>msg.operation = "read";
msg.dataType = "DM";
msg.address = "100";
msg.count = 10;  // Read 10 words
return msg;</pre>

    <p><b>Bit Read Example:</b></p>
    <pre>msg.operation = "read";
msg.dataType = "DM";
msg.address = "100.05";  // Read bit 5 of DM100
msg.count = 1;  // Read 1 bit (returns boolean)
return msg;
// Or read multiple bits:
msg.address = "100.05";
msg.count = 8;  // Read 8 bits starting from bit 5
return msg;  // Returns array of 8 booleans</pre>

    <p><b>Multi-Address Read Example:</b></p>
    <pre>msg.operation = "read";
msg.address = [
    "100",                           // Read 1 word from DM100
    {address: "200", count: 5},      // Read 5 words from DM200
    {address: "300", dataType: "CIO", count: 2}  // Read 2 words from CIO300
];
return msg;
// Output: [{address: "100", dataType: "DM", value: ...}, ...]</pre>

    <p><b>Write Example:</b></p>
    <pre>msg.operation = "write";
msg.dataType = "DM";
msg.address = "100";
msg.payload = [100, 200, 300];  // Write 3 values
return msg;</pre>

    <p><b>Bit Write Example:</b></p>
    <pre>msg.operation = "write";
msg.dataType = "DM";
msg.address = "100.05";  // Write to bit 5 of DM100
msg.payload = true;  // Set bit to 1
return msg;
// Or write multiple bits:
msg.address = "100.05";
msg.payload = [true, false, true, false];  // Set 4 bits
return msg;  // Writes to bits 5, 6, 7, 8 of DM100</pre>

    <p><b>Change Mode Example:</b></p>
    <pre>msg.operation = "mode";
msg.mode = "RUN";  // or "MONITOR" or "STOP"
return msg;</pre>
</script>
